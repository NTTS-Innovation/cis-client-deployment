$params = @{"subscription_id"=$Env:SubscriptionId;
  "resource_group"=$Env:ResourceGroup;
  "eventhub_namespace"=$Env:eventhubNameSpace;
  "eventhub_name"=$Env:EventHubName;
  "eventhub_policy_name"=$Env:EventHubPolicyName;
  "consumer_group_name"=$Env:EventHubConsumerGroup;
  "region"=$Env:Region;
  "primary_key"=$Env:EventHubPrimaryKey;
  "deployment_time"=$Env:DeploymentTime;
}

Write-Output ($params|ConvertTo-Json)


Try{
  $Response = Invoke-WebRequest -Uri $Env:EndPoint -Method POST -Body ($params|ConvertTo-Json) -ContentType "application/json" -Headers @{ 'x-functions-key' =  $Env:ApiKey } -ErrorAction Stop
}

Catch{
  $message = $_.message.exception
  Write-Error $message
  $DeploymentScriptOutputs = @{}
  $DeploymentScriptOutputs['text'] = $message
  throw "Invalid Url or API Key, Please deploy again"
}

Finally{
  If ($Response.statuscode)
  {
  Write-Output $Response.statuscode
  $DeploymentScriptOutputs = @{}
  $DeploymentScriptOutputs['text'] = $Response.statuscode
  }
}

